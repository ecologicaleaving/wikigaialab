#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-commit hook for WikiGaiaLab
echo "ğŸ” Running pre-commit checks..."

# 1. Type checking
echo "ğŸ“ Checking TypeScript types..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript type checking failed"
  exit 1
fi

# 2. Linting
echo "ğŸ§¹ Running ESLint..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ ESLint failed"
  exit 1
fi

# 3. Format checking
echo "ğŸ’… Checking code formatting..."
npm run format:check
if [ $? -ne 0 ]; then
  echo "âŒ Code formatting check failed"
  echo "ğŸ’¡ Run 'npm run format' to fix formatting issues"
  exit 1
fi

# 4. Environment validation
echo "ğŸ”§ Validating environment configuration..."
node -e "
const { validateEnv } = require('./src/lib/env.ts');
const result = validateEnv();
if (!result.success) {
  console.error('âŒ Environment validation failed');
  process.exit(1);
}
console.log('âœ… Environment validation passed');
"

# 5. Unit tests (only staged files)
echo "ğŸ§ª Running unit tests..."
npm run test -- --passWithNoTests --findRelatedTests --bail
if [ $? -ne 0 ]; then
  echo "âŒ Unit tests failed"
  exit 1
fi

# 6. Build check (only on main/staging branches)
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "staging" ]; then
  echo "ğŸ—ï¸  Running build check..."
  npm run build
  if [ $? -ne 0 ]; then
    echo "âŒ Build failed"
    exit 1
  fi
fi

echo "âœ… All pre-commit checks passed!"